<link rel=stylesheet href="topic:style.css" type="text/css">
<META Name="keywords" Content="Интеграционная шина, Интеграция, Мастер">

# Руководство пользователя интеграционной шины

## Для кого это руководство

Для пользователей продуктов TURBO X: визуальный мастер настройки обмена данными позволяет настраивать обмен данными между системами.

## Описание системы

Интеграционная шина призвана облегчить работу с внешними данными. Решаемые задачи:

* Обмен данными между модулями системы ТУРБО
* Интеграция с веб-сервисами, например: личный кабинет, портал и т.д.
* Импорт/экспорт данных из файлов в различных форматах
* Передача данных через клиент банк (csv, xml)

## Быстрый старт

* [Предварительные условия][Предварительные условия]
* [Установка ESB][Установка ESB]
* [Настройка расположения планировщика][Настройка расположения планировщика]
* [Использование мастера настройки в TURBO X][Использование мастера настройки в TURBO X]
    * [Настройка расположения ESB][Настройка расположения ESB]
    * [Выбор направления обмена][Выбор направления обмена]
    * [Настройка точки подключеия][Настройка точки подключения]
    * [Настройка соответствия полей][Настройка соответствия полей]
    * [Настройка фильтра][Настройка фильтра]
    * [Настройка режима запуска][Настройка режима запуска]
    * [Настройка исполнения обмена][Настройка исполнения обмена]

Настройка заключается в создании точек подключения для всех источников и получателей данных.

### Предварительные условия

Перед началом настройки обмена убедитесь в следующем:

* В вашем контуре установлена и настроена платформа TURBO X и конфигурация не ниже версии 10.2
* Проект Integration подключен к информационной базе

### Установка ESB

Заключается в разворачивании виртуальной машины из образа в том же контуре, где находится платформа.

Подробнее о развертывании см. в [руководстве](Topic:Integration.Интеграция.Версия 1_0.О системе.Руководство по ESB)

*Примечание: ESB - Enteprise Service Bus - сервис, обеспечивающий передачу (транспорт) данных. В некоторых случаях в платформе ТУРБО X используется термин **MiddleWare**, который равнозначен **ESB**.*

### Настройка расположения планировщика

[**Планировщик**](Topic:kernel.Администрирование.Планировщик.Default) - сервис, отвечающий за выполнение заданий. Перед началом работы администратор должен явно указать его расположение.

* Перейдите в справочник глобальных переменных:

**Главное меню \\ Администрирование \\ Настройки \\ Базовые настройки \\ Глобальные настройки**

* Добавьте переменную со следующими значениями:
    * Код - **ShedulerHostName**
    * Название - **Адрес расположения планировщика**
    * Значение - адрес и порт, настроенные в процессе установки платформы ТУРБО Х в формате *адрес:порт*

### Использование мастера настройки в TURBO X

Для запуска мастера перейдите в меню:

**Главное меню \\ Интеграция \\ Сервис \\ Мастер настроек**

Настройка обмена осуществляется через пошаговый мастер. На любом шаге можно вернуться назад и внести изменения.

Результатом будет настройка обмена, включающая в себя точку подключения, настройку соответствия полей, расписание обновления данных и задание в планировщике.

При использовании мастера устанавливайте флаги на требуемые варианты, заполняйте поля и перемещайтесь кнопками **Назад** и **Далее**. Сохранение новых элементов справочников и применение изменений осуществляется только по окончании работы мастера - по кнопке **Применить настройки**.

#### Настройка расположения ESB

Укажите адрес расположения сервиса **ESB**, полученный на шаге [Установка ESB][Установка ESB] и нажмите [**Далее**][Выбор направления обмена]

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10909.jpg)

Можно указать адрес расположения ESB через [Глобальные настройки](topic:Bas.Администрирование.Настройки.Глобальные настройки) следующим образом:

![](topic:Integration.AddFiles.Screenshot_11285.jpg)

- Код – MiddleHostName
- Название – произвольное наименование
- Значение -  http://{адрес машины ESB}:8001/asb/


#### Выбор направления обмена

Обмен имеет три направления - **загрузка** данных из внешнего объекта в документы и справочники информационной базы, **выгрузка** данных во внешний объект и **внутренний обмен** между проектами информационной базы.

**Внутренним объектом** считается любой справочник или документ информационной базы, **Внешним** - любой файл вне её.

Укажите требуемый вариант из выпадающего списка и нажмите [**Далее**][Настройка точки подключения]

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10910.jpg)

#### Настройка точки подключения

Укажите существующую точку подключения или [создайте новую][Создание новой точки подключения]. При использовании существующей точки её параметры будут обновлены.

Настройте параметры точки: измените значения, если необходимо.

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10911.jpg)

Нажмите [**Далее**][Настройка соответствия полей]

##### Создание новой точки подключения

Установите флаг *Создать новую точку подключения*.

В появившемся поле укажите тип точки подключения:

* В списке типов нажмите <img src="Topic:Integration.AddFiles.Buttons.шестеренки.png" class="btn"/>, чтобы обновить список доступных из **ESB**
* Выберите подходящий из предложенных типов. Подробнее о типах читайте в [Типы потоков](Topic:Integration.Интеграция.Версия 1_0.Справочники.Типы точек подключения.Типы потоков)
* Если среди загруженных нет подходящего, создайте [пользовательский тип][Создание нового типа точки]
* Укажите наименование - оно будет отображено в списках и в очереди выполнения

Список параметров определяется типом точки.

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10913.jpg)

Подробнее см. [Точка подключения](Topic:Integration.Интеграция.Версия 1_0.Справочники.Точка подключения)

##### Получение доступных типов точек подключения

Добавление новых, дублирование уже имеющихся типов точек подключения **ЗАПРЕЩЕНО**


Получить доступные типы точек подключения внутренние или ESB возможно только по кнопке **Сервисы**![](topic:Integration.AddFiles.Buttons.Btn_Services.png) :

![](topic:Integration.AddFiles.Screenshot_11048.jpg)

- **Получить доступные типы точек подключения (внутренние)** - точки, которые определены внутри проекта, для их работы не требуется подключение ESB;
- **Получить доступные типы точек подключения  (ESB)**- внешний сервис, который предоставляет дополнительные типы потоков. Необходимо подключить внешний сервис ESB, подробнее[Руководство по развертыванию ESB](topic:Integration.Интеграция.Версия 1_0.О системе.Руководство по ESB).

Подробнее см. [Тип точки подключения](Topic:Integration.Интеграция.Версия 1_0.Справочники.Тип точки подключения)

#### Настройка соответствия полей

На данном шаге настраивается сопоставление полей источника и приемника данных.

Укажите существующую настройку соответствия или [создайте новую][Создание новой настройки соответствия полей].

Настройте параметры соответствия в открывшейся форме и нажмите [**Далее**][Настройка фильтра]

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10914.jpg)

##### Создание новой настройки соответствия полей

Установите флаг *Создать новое соответствие полей* и заполните открывшуюся ниже форму.

* Наименование - произвольное имя настройки сопоставления полей, будет отображаться в списках
* Направление обмена - **Загрузка**, **Выгрузка** или **Внутренний обмен**

Если выбрано направление **Загрузка** или **Выгрузка**:

* Проект - внутренний проект, подключенный к информационной базе
* Тип объекта - форма, картотека или запись. Для того, чтобы загружать/выгрузить справочники в Соответствии полей должен быть тип объекта Запись.
* Объект – конкретный объект, принадлежащий к данному типу и входящий в выбранный проект
* Внешний объект - файл, участвующий в обмене - заполнение не обязательно. При выборе заполняется список полей из внешнего источника.

Направления **Загрузка** и **Выгрузка** в настройке сопоставления полей равнозначны - это значит, что настройка на выгрузку может быть использована и на загрузку данных, нет необходимости создавать два отдельных объекта настройки. Направление обмена является общей характеристикой настройки обмена и задается на другом шаге мастера.

Если выбран **Внутренний обмен**:

* Проект источник и Тип источника - имя проекта информационной базы и его справочник/документ, который будет источником данных
* Проект приемник и Тип приемника - имя проекта информационной базы и его справочник/документ, который будет приёмником данных

Далее требуется настроить поля соответствия между внутренним и внешним объектом.

Нажмите кнопку **Заполнить** <img src="Topic:Integration.AddFiles.Buttons.Заполнить.png" class="btn"/> - автоматически заполняет таблицу полями и их свойствами из внутреннего объекта (указанного выше в полях **Проект** и **Тип объекта**), а для внутреннего обмена - из источника или приемника по выбору пользователя. 

* Ключ. - флаг, показывающий, используется ли поле в качестве ключевого. Если не указать ни одного ключевого поля, им считается совокупность всех полей с типом внутренних данных **Шапка**
* Внутреннее - имя поля внутреннего объекта. Состоит из трех частей: Заголовок, [системное имя], (название таблицы)
* Тип - тип внутреннего поля, заполнен автоматически, не рекомендуется изменять его вручную
* Тип внутренних данных - заполнен автоматически согласно настройкам внутреннего объекта, недоступно для редактирования
* Способ сопоставления - подход, применяемый для установления соответствия между полями внутреннего и внешнего объектов. Варианты:
    * Точное соответствие - для случаев, когда передача из одного поля в другое происходит без смены типа (например, из string в string)
    * Поиск по значению - для случаев, когда требуется изменить тип и выбрать часть данных из объектного типа (например, когда поле источника является ссылкой на объект, группу объектов, таблицу и т.д., в приемника - значение одного из компонентов объекта)
    * С разыменованием - только для внутреннего обмена, соответствует варианту **Поиск по значению**
* Правило - системное имя внутреннего поля для способа сопоставления
* Внешнее - имя поля внешнего объекта, выбор из выпадающего списка, возможен ручной ввод
* Узел XML - столбец отображается только если указан внешний объект, чьи поля получены из XML

Дополнительные условия для обмена с XML файлом:

* В поле **Внешний объект** должен быть выбран объект с полями, полученными из XML
* в столбце **Узел XML** для полей с типом внутренних данных **Шапки** требуется выбрать content, для **Таблица** - line

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10915.jpg)

Подробнее см. [Соответствие полей](Topic:Integration.Интеграция.Версия 1_0.Справочники.Соответствие полей)

#### Настройка фильтра

Фильтр работает только на выгрузку данных во внешний объект. Фильтрация входящих данных будет реализована в следующих версиях.

Выберите существующий фильтр, [создайте новый][Создание нового фильтра] или пропустите этот шаг, нажав [**Далее**][Настройка режима запуска] - выбор фильтра не является обязательным шагом.

Внесите изменения в параметры

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10919.jpg)

Нажмите [**Далее**][Настройка режима запуска]

##### Создание нового фильтра

Установите флаг *Создать новый фильтр*. Заполните открывшуюся ниже форму:

* Наименование - произвольное имя, которое будет отображаться в списках
* Проект - внутренний проект, подключенный к информационной базе
* Тип объекта - справочники и документы выбранного выше проекта
* Фильтр - строковое представление фильтра, содержащее поля и условия их отбора. Строка может быть сформирована автоматически из строк таблицы по нажатию кнопки <img src="Topic:Integration.AddFiles.Buttons.Составить_фильтр.png" class="btn"/> и отредактирована вручную.

В таблице укажите правила отбора по каждому полю. Одна строка - одно поле:

* И/ИЛИ - логическая связку между строками таблицы
* Поле - поле внутреннего объекта
* Вид сравнения - знак, который будет стоять между выбранным полем и значением. Доступные знаки зависят от типа поля
* значение - зависит от типа

Подробнее см. [Фильтр](Topic:Integration.Интеграция.Справочники.Фильтр)

![](topic:Integration.AddFiles.ScreenShots.Screenshot_10920.jpg)

#### Настройка режима запуска

Процесс обмена данными может быть ручным или автоматическим - для этого выберите режим и настройте расписание. Независимо от режима, задание обмена попадает в справочник [Очередь выполнения](Topic:Integration.Интеграция.Версия 1_0.Справочники.Очередь выполнения).

Сохранить задание для запуска в ручном режиме:

![](topic:Integration.AddFiles.Screenshot_11223.jpg)

Если требуется запускать обмен автоматически, установите флаг Запускать по расписанию: 

* Установите флаг Использовать существующее расписание - укажите расписание для запуска автоматического обмена из картотеки [Расписание](topic:Integration.Интеграция.Версия 1_0.Справочники.Расписание).

![](topic:Integration.AddFiles.Screenshot_11224.jpg)

* Установите флаг Создать новое расписание - в открывшейся форме укажите правила запуска автоматического обмена.


Настройка расписания:

* Название - произвольное название расписания
* Дата и Время - для разового запуска в указанные дату и время
* Флаг *Периодическое* - если не установить флаг, то обмен отработает один раз, если установить - появятся дополнительные поля для настройки периодичности (все нижеперечисленные)
* Условие срабатывания - периодичность запуска задания
* Повторять - всегда, до даты, несколько раз
* Флаг *Активно всегда* - для бессрочных заданий
* Активно с .. до .. и флаги *Дата* и *Время* - поля для указания периода работы задания. Если период ограничен датой, установите флаг *Дата* и укажите даты начала и окончания в полях с .. по.. . Аналогично для периода, ограниченного временем.

![](topic:Integration.AddFiles.Screenshot_11225.jpg)

Нажмите [**Далее**][Настройка исполнения обмена]


***Важно! Для корректной работы загрузки/выгрузки по расписанию обязательно необходимо выполнить следующие  [Глобальные настройки](topic:Bas.Администрирование.Настройки.Глобальные настройки)***





#### Настройка исполнения обмена

![](topic:Integration.AddFiles.Screenshot_11226.jpg)

- Поле Программный класс обработки -- заполняется с помощью выпадающего списка. Список формируется из подключенных к ИБ программных классов обработки. Базовые процессоры -  Service.ILineProcessor или Service.IRecursiveProcessor;
- Поле Обновление данных - заполняется с помощью выпадающего списка: создать новый / обновить документ / пропустить.


Когда все поля будут заполнены, нажмите **Применить настройки**. Созданные в ходе работы мастера объекты будут записаны в справочники, если были использованы существующие объекты - они будут обновлены, задание обмена будет отображено в [Очереди выполнения](Topic:Integration.Интеграция.Версия 1_0.Справочники.Очередь выполнения).