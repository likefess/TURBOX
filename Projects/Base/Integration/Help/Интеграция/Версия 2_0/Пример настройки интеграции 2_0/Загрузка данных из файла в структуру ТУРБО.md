#Загрузка начальных остатков из файла CSV в структуру ТУРБО

Требуется загрузить начальные остатки, которые представлены данными в формате CSV.

**Пример файла для загрузки:**

           Name;Company;Склад;№ [PrintedNumber];от [EventTime];ТМЦ;Количество;Валюта;цена;Сумма
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 3 (готовой продукции);3/18;08.01.2019;Табурет;10;шт;100;1000
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 3 (готовой продукции);3/18;08.01.2019;Шкаф;2;шт;3500;7000
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 3 (готовой продукции);3/18;08.01.2019;Стол;5;шт;2500;12500
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);4/18;15.01.2019 16:44:11;Ароматизатор для сауны Camylle Люкс смесь 250 мл;10;шт;700;7000
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);4/18;15.01.2019 16:44:11;Ароматизатор для сауны Camylle Азия смесь 250 мл;10;шт;750;7500
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);4/18;15.01.2019 16:44:11;Ароматизатор для сауны Camylle Эвкалипт / Мята 250 мл;10;шт;800;8000
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);5/18;24.01.2019 16:49:42;Бытовка 3X4;2;шт;211864.406779661;508474.58
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);6/18;06.02.2019;Гигрометр Sawo 100-HBA;2;шт;900;1800
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);6/18;06.02.2019;Гигрометр Cariitti SQ с подсветкой;2;шт;900;1800
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);6/18;06.02.2019;Гигрометр Lacoform;2;шт;950;1900
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);7/18;20.02.2019;Ароматизатор для сауны Camylle Люкс смесь 250 мл;5;шт;385;1925
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);7/18;20.02.2019;Ароматизатор для сауны Camylle Азия смесь 250 мл;5;шт;330;1650
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);7/18;20.02.2019;Ароматизатор для сауны Camylle Эвкалипт / Мята 250 мл;5;шт;440;2200
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);8/18;01.03.2019;Гигрометр Sawo 100-HBA;5;шт;900;5400
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);8/18;01.03.2019;Гигрометр Cariitti SQ с подсветкой;5;шт;900;5400
           Остатки ТМЦ;"ООО ""Лидер""";Склад № 1 (товарный);8/18;01.03.2019;Гигрометр Lacoform;5;шт;950;5700

 Начальные остатки в базе Турбо хранятся Управление цепочками поставок/ Запасы / Начальные остатки / Остатки ТМЦ.

 Требуется настроить загрузку из файла формата  CSV в документ Турбо Остатки ТМЦ.

**Порядок действий для загрузки:**

1. Необходимо создать элемент справочника [Настройка][Настройка] (Путь: Интеграция - Данные и справочники - Основные справочники - Настройка) и заполнить параметры настройки.
2. Создать [Источник][Источник] - файл CSV с начальными остатками
3. Создать [Приемник][Приемник] - точка подключения TB запись
4. Создать [Соответствие полей][Соответствие полей] между источником и приемником
5. [Запуск настройки обмена][Запуск настройки обмена] - может быть выполнен вручную или запущен по [Расписанию](topic:.Интеграция.Версия 2_0.Данные и справочники.Расписание)
6. [Логирование][Логирование], любая настройка обмена может быть записана в лог.




##Настройка

**Создать [Настройку](topic:.Интеграция.Версия 2_0.Данные и справочники.Настройка) Процессор соответствия полей:**


![](topic:.AddFiles.Screenshot_11603.jpg)

* Наименование произвольное;
* Тип обработки = [Процессор соответствия полей](topic:.Интеграция.Версия 2_0.Данные и справочники.Программный класс обработки.Процессор соответствия полей);
* Источник - с помощью кнопки Выбор![](topic:Integration.AddFiles.Buttons.Btn_select.png) откройте картотеку [Точки подключения](topic:.Интеграция.Версия 2_0.Данные и справочники.Точка подключения), если нужной точки подключения нет, то создайте новую точкой подключения "Начальные остатки CSV" с помощью кнопки Добавить ![](topic:Com.AddFiles.Btn_Add.png). Заполните [Источник][Источник];
* Приемник - с помощью кнопки Выбор![](topic:Integration.AddFiles.Buttons.Btn_select.png) откройте картотеку [Точки подключения](topic:.Интеграция.Версия 2_0.Данные и справочники.Точка подключения), если нужной точки подключения нет, то создайте новую точкой подключения "Остатки ТМЦ ТВ" с помощью кнопки Добавить ![](topic:Com.AddFiles.Btn_Add.png). Заполните [Приемник][Приемник];
* [Соответствие полей][Соответствие полей] - с помощью кнопки Выбор![](topic:Integration.AddFiles.Buttons.Btn_select.png) откройте картотеку [Соответствие полей](topic:.Интеграция.Версия 2_0.Данные и справочники.Соответствие полей), создайте правило сопоставления "Правило загрузки начальных остатков" с помощью кнопки Добавить ![](topic:Com.AddFiles.Btn_Add.png).









##Источник

**Создание источника данных**:


[Точка подключения](topic:.Интеграция.Версия 2_0.Данные и справочники.Точка подключения)

  Создаем точку подключения  с наименованием “Начальные остатки CSV”.

![](topic:.AddFiles.Screenshot_11600.jpg)



* [Тип точки подключения](topic:.Интеграция.Версия 2_0.Данные и справочники.Тип точки подключения)

Задаем Тип точки подключения - [Таблица CSV](topic:.Интеграция.Версия 2_0.Данные и справочники.Типы точек подключения.Таблица CSV)  (идет в базовой поставке):


* В параметре  FileName указать путь к файлу CSV, в котором хранятся начальные остатки.
* [Структура объекта](topic:.Интеграция.Версия 2_0.Данные и справочники.Структура объекта) - для создания новой структуры объекта воспользуйтесь кнопкой **Сервисы** ![](topic:Integration.AddFiles.Buttons.Btn_Services.png) - ![](topic:.AddFiles.Buttons.Btn_Add_new.png)  Создать структуру объекта:
    * Наименование "Структура начальных остатков CSV";
    * В Список таблиц объекта добавить таблицу 2 уровня;
    * Воспользоваться кнопкой **Разнести поля** для переноса отмеченных флагами полей в созданную таблицу;
    * Структуру объекта сохранить кнопкой **ОК** ![](topic:Com.AddFiles.Buttons.Btn_Post.png).

![](topic:.AddFiles.Screenshot_11621.jpg)


<!--* После создания Точки подключения воспользоваться кнопкой **Сервисы** ![](topic:Integration.AddFiles.Buttons.Btn_Services.png) - Проверить настройки. Для точек с типом потока, полученным из ESB, происходит отправка запроса в ESB для проверки корректности введенных данных. Результат отображенный на экране в диалоговом окне Информация должен быть: Настройки корректны!-->

Правило Дескриптора для [типа точки подключения Таблица CSV (Версия2)](topic:.Интеграция.Версия 2_0.Данные и справочники.Типы точек подключения.Таблица CSV)



##Приемник

**Создание приемника данных:**

[Точка подключения](topic:.Интеграция.Версия 2_0.Данные и справочники.Точка подключения)

  Создаем точку подключения  с наименованием "Остатки ТМЦ ТВ".

![](topic:.AddFiles.Screenshot_11601.jpg)



* [Тип точки подключения](topic:.Интеграция.Версия 2_0.Данные и справочники.Тип точки подключения)

Задаем Тип точки подключения - [ТВ запись](topic:.Интеграция.Версия 2_0.Данные и справочники.Типы точек подключения.ТВ запись)  (идет в базовой поставке):
* Параметры:
    * *Project* - выбранный проект в Турбо, подключенный к информационной базе "SCM";
    * *Record* - выбранный класс записи в Турбо, входящий в проект Project "Rec.Документы.Продажи.ОтгрузкаТМЦПокупателю";
    * *CardForm* - картотека выбранного класса записи Record, подставилась автоматически "Upr.Tab.Данные.Процессы";
    * *Filter* - Фильтр, по которому отбираются конкретные записи. В картотеке Остатки ТМЦ по щелчку правой кнопки мыши выбираем Свойства на закладке Картотека поле Фильтр:

     ![](topic:.AddFiles.Screenshot_11604.jpg)

* [Структура объекта](topic:.Интеграция.Версия 2_0.Данные и справочники.Структура объекта) - для создания новой структуры объекта воспользуйтесь кнопкой **Сервисы** ![](topic:Integration.AddFiles.Buttons.Btn_Services.png) - ![](topic:.AddFiles.Buttons.Btn_Add_new.png)  Создать структуру объекта:
    * Наименование "Структура начальных остатков ТВ";
    * Структуру объекта сохранить кнопкой **ОК** ![](topic:Com.AddFiles.Buttons.Btn_Post.png).

![](topic:.AddFiles.Screenshot_11622.jpg)

<!--* После создания Точки подключения воспользоваться кнопкой **Сервисы** ![](topic:Integration.AddFiles.Buttons.Btn_Services.png) - Проверить настройки. Для точек с типом потока, полученным из ESB, происходит отправка запроса в ESB для проверки корректности введенных данных. Результат отображенный на экране в диалоговом окне Информация должен быть: Настройки корректны!-->

Правило Дескриптора для [типа точки подключения ТВ запись (Версия2)](topic:.Интеграция.Версия 2_0.Данные и справочники.Типы точек подключения.ТВ запись)

##Соответствие полей

**Соответствие полей между источником и приемником:**

Создаем новое [Соответствие полей](topic:.Интеграция.Версия 2_0.Данные и справочники.Соответствие полей) с наименованием "Правило загрузки начальных остатков".

![](topic:.AddFiles.Screenshot_11607.jpg)

* Объект источник - заполняется с помощью списка Структур объектов созданный источник данных (кнопка Выбор ![](topic:Integration.AddFiles.Buttons.Btn_select.png)) - "Структура начальных остатков CSV";
* Объект приемник - заполняется с помощью списка Структур объектов созданный приемник данных (кнопка Выбор ![](topic:Integration.AddFiles.Buttons.Btn_select.png)) - "Структура начальных остатков ТВ".
* Заполняем блок Таблицы:
    * Для таблиц первого уровня обновление данных - Создать новый, настроить соответствие полей таблиц (кнопка ![](topic:Com.AddFiles.Buttons.Btn_Zamena.png)):

    ![](topic:.AddFiles.Screenshot_11623.jpg)

    В поле Company исходного файла находится имя компании, поэтому для загрузки в поле Предприятие в приемнике нужно выбрать "Правило преобразования"  [Поиск по значению](topic:.Интеграция.Версия 2_0.Данные и справочники.Правила преобразования.Поиск по значению) с поиском записи по полю Name.

    <!--* Для поля Company "Правило преобразования"  используется  [Поиск по значению](topic:.Интеграция.Версия 2_0.Данные и справочники.Правила преобразования.Поиск по значению), в поле приемника стоит Предприятие - объектный тип.!-->

   При Настройке параметров преобразования для Предприятия с помощью кнопки ![](topic:.AddFiles.Buttons.Btn_Edit.png) открываем форму и  Имя поля поиска задаем Name.   (Для Склада Имя поля поиска тоже Name).
  <!--* , потому что в файле компания задана наименованием  !-->




    ![](topic:.AddFiles.Screenshot_11624.jpg)

    * Для таблиц второго уровня обновление данных - Создать новый, настроить соответствие полей таблиц (кнопка ![](topic:Com.AddFiles.Buttons.Btn_Zamena.png)):

    ![](topic:.AddFiles.Screenshot_11625.jpg)

    Для ТМЦ [Поиск по значению](topic:.Интеграция.Версия 2_0.Данные и справочники.Правила преобразования.Поиск по значению) будет осуществляться по Name, для Валюта - по Code.

    * Соответствие полей сохранить кнопкой **ОК** ![](topic:Com.AddFiles.Buttons.Btn_Post.png).


##Запуск настройки обмена

Настройку обмена можно запустить как вручную в любой момент,так и по расписанию в соответствии с настройкой расписания. Одна настройка может быть связана с несколькими расписаниями.

Запуск настройки обмена осуществляется с помощью кнопки **Сервисы** ![](topic:Integration.AddFiles.Buttons.Btn_Services.png):

- Выполнить - загрузка/выгрузка выполняется на клиенте;
- Выполнить асинхронно - загрузка/выгрузка выполняется на сервере, при этом клиент продолжает работу. После выполнения клиенту сообщается о загрузке в диалоговом окне;
- Добавить расписание - открывает для создания форму [Расписание](topic:.Интеграция.Версия 2_0.Данные и справочники.Расписание) на основе введенных в настройке данных;
- Просмотр расписания - открывает картотеку [Расписание](topic:.Интеграция.Версия 2_0.Данные и справочники.Расписание) с фильтром по данной настройке.


##Логирование

Для просмотра лога выполнения воспользуйтесь картотекой [Логирование событий](topic:.Интеграция.О системе.Логирование) при условии включенного логирования.


