#Сервис мониторинга почтовых аккаунтов
---
####Назначение сервиса
Сервис предназначен для мониторинга почтовых серверов связанных с почтовыми аккаунтами зарегистрированными в Системе,
логирования и своевременного уведомления заинтересованных лиц о возникших ошибках работы почтовых серверов.
Сервис в настоящий момент в ходе мониторинга умеет выполнять следующие задачи:
- проверка соединения с сервером входящей почты;
- проверка соединения с сервером исходящей почты;
- проверка и загрузка входящей почты;
- любые комбинации из вышеперечисленных задач.

####Настройка параметров сервиса
Настройка параметров сервиса производится в экранной форме "Настройки инфобазы"
(меню `Администрирование->Настройки->Базовые настройки`) на закладке "Сервисы" в разделе "Служба мониторинга почтовых аккаунтов".

![](topic:.Администрирование.AddFiles.screen_MailAccountMonitorSettings.png)

В поле `Почтовый аккаунт для мониторинга` необходимо указать почтовый аккаунт, используемый Сервисом для отправки уведомлений о произошедших событиях в ходе мониторинга.
Если поле оставить незаполненным, то Сервис не будет отправлять уведомления, а будет только писать сообщения в протокол.

При помощи параметра `Периодичность мониторинга` указывается интервал в секундах между итерациями мониторинга.

В поле `Интервал повторной отправки письма` указывается интервал в секундах по истечении которого Сервис отправит повторное письмо о произошедшем событии (например ошибка соединения с почтовым сервером),
если к тому моменту ситуация не изменится (восстановиться соединение с почтовым сервером и т.п.). Значение `-1` означает, что повторную отправку осуществлять не надо.

Также, для отправки уведомлений электронной почтой необходимо в одноименном разделе указать шаблоны писем, используемых при подготовке уведомлений.
При создании шаблонов можно в теме и теле (как в тексте так и в HTML) использовать макросы:
- `%Message` - текст сообщения о событии (например, текст ошибки и т.п.);
- `%Account` - почтовый аккаунт при мониторинге которого наступило событие.
Дополнительно к вышеперечисленным макросам можно использовать макросы, имена которых совпадают с именами параметров в записи протокола о соответствующем событии.

####Управление сервисом

#####Запуск
Запуск Сервиса производится автоматически при добавлении задания на мониторинг, если Сервис не был запущен ранее.
Также запустить сервис можно при помощи Планировщика или программно вызовом соответствуещго метода АПИ Сервиса.

***Пример задания Планировщику на запуск Сервиса***
```
<Action Name="Запуск сервиса" Type="ExecuteProc" InfoBase="Demo" ExecStr="MailServerMonitor.StartService(23:50, true)"/>
```

#####Остановка
Остановка Сервиса производиться:
- автоматически, при достижении времени останова, указанного при запуске Сервиса (если оно было указано);
- автоматически, если при запуске Сервиса в параметре у Сервиса нет заданий на мониторинг и в течении одной итерации таковых не поступило;
- при помощи вызова соответствующего метода АПИ Сервиса (`StopService`) произведенного программно или при исполнении задания Планировщика.

***Пример задания Планировщику на остановку Сервиса***
```
<Action Name="Stop service" Type="ExecuteProc" InfoBase="Demo" ExecStr="MailServerMonitor.StopService"/>
```

**ВАЖНО:** При автоматическом запуске при появлении задания на мониторинг не указывается время остановки. Также в качестве `aWaitForWork` передается `false`.
Это означает, что сервис остановится после удаления последнего задания на мониторинг или явного вызова `StopService` посредством АПИ Сервиса или при помощи Планировщика.

#####Добавление задания
Добавление задания на мониторинг производится автоматически при установке в карточке почтового аккаунта полю `Мониторинг` значения отличного от `не использовать мониторинг`.
![](topic:.Администрирование.AddFiles.screen_MailAccountSettings_Monitoring.png)

Также добавление задание можно произвести программно путем вызова соответствующего метода АПИ Сервиса.

#####Удаление задания
Удаление задания производится автоматически при при установке в карточке почтового аккаунта полю `Мониторинг` значения равного `не использовать мониторинг`.
Также удаление задание можно произвести программно путем вызова соответствующего метода АПИ Сервиса.

####АПИ сервиса

#####ServiceActive
```
  func ServiceActive(var aPipe :Pipe = nil) :Boolean;
```
Проверяет, запущен ли сервис мониторинга почтовых серверов.

#####StartService
```
  proc StartService( aTill            :Date    = nil;
                     aWaitForWork     :Boolean = false;
                     aForceRun        :Boolean = false
                     );
```
Запускает сервис мониторинга почтовых серверов.
Если `aForceRun = false`, то предварительно проверяет не работает ли он уже.
В противном случае (`aForceRun=true`) запускает сервис безусловно.
Через параметр `aTill` можно передать дату и время остановки сервиса.
Параметр `aWaitForWork` предназначен для указания сервису следует ли ему,
в случае отсутствия заданий, ожидать их поступления или заканчивать свою работу.

#####StartServiceEx
```
  func StartServiceEx( aTill           :Date    = nil;
                       aWaitForWork    :Boolean = false;
                       aForceRun       :Boolean = false
                       ) :Pipe;
```
Запускает сервис мониторинга почтовых серверов.
В отличии от `StartService` возвращает канал связи с сервисом.

#####StopService
```
  proc StopService;
```
Останавливает работу сервиса мониторинга почтовых серверов.

#####RestartService
```
  proc RestartService(aTill :Date);
```
Осуществляет перезапуск сервиса мониторинга почтовых серверов.

#####AddWork
```
  proc AddWork(anAccount :Rec.Config.MailAccount)
```
Добавляет сервису задание на мониторинг серверов аккаунта `anAccount`.

#####DelWork
```
  proc DelWork(anAccount :Rec.Config.MailAccount);
```
Отправлет сервису команду на удаление задания на мониторинг `anAccount`.

#####UpdateWork
```
  proc UpdateWork(anAccount :Rec.Config.MailAccount);
```
Отправлет сервису команду на изменение(update) задания на мониторинг `anAccount`.


