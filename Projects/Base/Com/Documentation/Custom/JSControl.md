---
Keywords: IJSControl
---

# Разработка элементов управления на основе IJSControl

Класс [IJSControl](topic:.Custom.ComClasses.Ctrl.IJSControl.Default) предоставляет
инструментарий для создания элементов управления на основе библиотек JavaScript.

Для создания нового элемента управления на основе библиотеки
JavaScript необходимо

1. Создать класс-обработчик как наследника IJSControl и определить в нем свойства и методы
2. Разработать веб-часть элемента управления и определить ее связь со свойствами и методами класса-обработчика.

## Разработка веб-части элемента управления

### Требования к исходному кода веб-части

Основой веб-части является базовая веб-страница, которая загружается
во встроенный браузер (IBrowser) для нативного клиента и встраивается в iframe для веб-клиента.
Название страницы должно соответствовать значению свойства `BasePage` класса элемента
управления (значение по умолчанию `default.html`).

Исходный код веб-части размещается в отдельной папке во вложениях проекта.
Путь до папки должен соответствовать значению свойства `StaticContentFolder`
класса элемента управления (значение по умолчанию `Attachment\JSControl\%имя класса%`).

Базовая веб-страница может содержать ссылки на библиотеки JavaScript и библиотеки стилей CSS.
В случае использования относительных ссылок на файлы библиотек, они должны быть размещены
в одной папке с базовой веб-страницей.
Ключевой библиотекой, отвечающей за взаимодействие браузера и веб-клиента является библиотека `base.js`.
Чтобы подключть её, необходимо скопировать ее в папку с базовой страницей и указать ссылку:

    <script src="base.js"></script>

В процессе работы элемент управления может быть уничтожен и воссоздан заново.
В нативном клиенте это происходит при перерисовке (Redraw).
В веб-клиенте он уничтожается когда текущая форма (закладка) становится неактивной
и формируется заново при последующей активацией формы (закладки) пользователем.
Это требует сохранения/восстановления состояния элемента управления.

Для сохранения состояния элемента управления необходимо определить метод `window.saveData`.
Например,

    window.saveData = function(){return someObj}

Получение ранее сохраненного состояния элемента управления осуществляется при помощи
встроенного метода `window.getData()`.

Если в нативном клиенте требуется поддержка браузера IE, то для сохранения состояния необходимо
подключить пустой js-файл `localstorage.js`, причём делать это нужно после `base.js`:

    <script src="base.js"></script>
    <script src="localstorage.js"></script>

### Взаимодействие объекта класса-обработчика и веб-части

Взаимодействие объекта класса-обработчика и веб-части реализовано при помощи
библиотеки `base.js`. Текущая версия библиотеки размещается во вложении проекта
`Com` в папке `Attachment\JSControl`.

Вызов из веб-части метода или события класса-обработчика при помощи
метода `window.CallProcEx(method,args)`, где `method` - имя метода
или обработчика события, `args` - массив аргументов метода или
обработчика события (поддерживаются только типы из стандарта JSON).

Вызов из объекта класса обработчика JavaScript кода в контексте веб-части
осуществляется при помощи методов `ExecuteScript` и `ExecuteScriptAsync`
из базового класса IJSControl. Первый аргумент обеих методов - текст JavaScript
кода, который необходимо исполнит в контексте веб-части. В методе
`ExecuteScriptAsync` дополнительно указывается аргумент `aOnResult` типа
`TOnExecuteScriptAsyncResult`, который позволяет задать обработать результат
выполнения JavaScript кода.

#### Различия исполнения веб-части в нативном клиенте, веб-клиенте и при отладке

При отображении базовой страницы веб-части в URL добавляется хэш в зависимости от
среды исполнения:

* нативный клиент - `#client`
* веб-клиент - `#web`
* отладка - любой другой хэш или отсутствие хэша

В библиотеке `base.js` информация о среде исполнения используется для определения
способа взаимодействия с объектом класса-обработчика. В отладочном режиме
взаимодействие не осуществляется, а попытки вызова методов объекта класса-обработчика
выводятся в JavaScript консоль браузера.