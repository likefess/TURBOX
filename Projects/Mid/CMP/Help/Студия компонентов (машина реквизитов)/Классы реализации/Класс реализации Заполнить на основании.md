#Класс реализации "Заполнить на основании".md 

Реквизит с классом реализации Сервис заполнения документа "на основании" позволяет использовать сервис, переносящий информацию из одного документа или группы документов в другой, в том числе во вновь созданный документ.

Сервис может работать в различных режимах, называемых вариантами переноса информации:

####Вариант переноса "Создать новый документ на основании данного"
* Настройка варианта заполнения
    * В поле "Тип нового документа" следует указать тип создаваемого документа, куда будет переноситься информация. 
    * Разбивка на документы. Иногда, при переносе информации необходимо создать сразу несколько документов. В таком случае следует настроить параметры разбиения данных в документе-основании: 
        * Вариант "Не разбивать" указывается в случае, когда нет необходимости создавать сразу несколько документов. 
        * Если был выбран вариант "По формуле разбиения", то создается один или более документов в зависимости от значения формулы разбиения. Формула разбиения задается в Настройках табличного переноса. 
        * "По признакам разбиения в таблице" - создается один или более документов в зависимости от флага "Разбиение", указанного в Настройках табличного переноса. 
    * Вид связи между документами. По умолчанию, после создания документа на основании другого, сохраняется ссылка на документ-основание. Однако можно настроить связь между документом-основанием и созданным документом с помощью данной опцией. Возможные значения: 
        * Не сохранять ссылку на документ-основание - ссылка на документ-основание не будет сохранена. 
        * Сохранять в новом документе ссылку на документ-основание - ссылка будет сохранена. В этом случае доступна опция "При удалении документа-основания", где можно указать: 
            * Требовать очистки ссылки из созданного документа. При выбранном варианте, если документ-основание удаляется, пользователю будет задан вопрос об очистке ссылок из созданных документов. Если пользователь подтвердит очистку ссылок, то удаление пройдет успешно, иначе документ-основание не удалится. 
            * Удалять ссылку автоматически - ссылка будет удалена, не сообщив пользователю об удалении. Документ-основание удалится в любом случае. 
        * Добавлять новый документ в список зависимостей исходного - эта опция доступна только в том случае, если в настройках информационной базы указано использование проекта "Контроль". Если выбран этот вариант связи, то созданный/заполняемый документ будет добавлен в список зависимостей документа-основания. 
    * Поместить созданный документ в реквизит - документ, в который переносится информация можно записать в ссылочный реквизит. 
    * Созданный документ сохранять. Предоставляется возможность сохранить созданный документ: 
        * Сразу. Созданный документ будет сохранен сразу, независимо от того, был ли сохранен документ-основание. 
        * Вместе с основанием (до него) - сначала будет сохранен созданный документ, затем документ-основание. Такой вариант сохранения необходим, чтобы не нарушить порядок записи элементов и групп. В данном случае, будет создан сначала элемент, а затем группа, в котором будет находиться созданный элемент. Однако если документ-основание не был сохранен, то и созданный на его основании документ тоже не будет сохранен. 
        * Вместе с основанием (после него) - при сохранении, сначала будет сохранен документ-основание, затем порожденный документ. Другими словами, созданный документ будет сохранен в том случае, если документ-основание сохранили. Иначе - ни один из документов, как документ-основание, так и порожденные от него, не будут сохранены. В этом случае, сначала будет создана группа, а затем уже и сам элемент этой группы. Порядок записи групп и элементов не будет нарушен. 


* Настройка переноса шапки
На этом этапе настройки данного варианта указывается, куда будут перенесены шапочные реквизиты документа-основания. Такая возможность предоставляется в таблице "Настройки переноса шапки из документа", где задаются: 
    * Тип приемника. Документ, который создают на основании, может принимать информацию в виде реквизита, поля записи или в виде дополнительного поля. 
    * Приемник данных шапки. В зависимости от того, что было выбрано типом приемника, в данной колонке указывается сам приемник (реквизит, поле или доп. поле). Если же реквизит и поле можно выбрать из картотеки и перечня записей соответственно, то дополнительное поле следует указывать вручную. 
    * При условии. На перенос значения можно наложить условие. Если условие будет выполнено, то значение будет записано в реквизит, поле или доп. поле, иначе - нет. Условие задается формулой, которая должна возвращать значение логического типа. 
    * Заполнять по формуле. Формула заполнения пишется по тем же правилам, что и формулы пересчетов реквизитов в карточке типа объекта, для чего можно использовать редактор формул, открывающийся по кнопке обзора. Следует обратить внимание, что в данном случае указывается реквизит, поле или дополнительное поле заполняемого документа, а формула вычисляется в контексте исходного документа - того, в котором был вызван данный сервис. 


* Настройка табличного переноса.
Перечень реквизитов, полей и дополнительных полей таблицы документа и формул для их заполнения. Настройки данного раздела управляют переносом информации в таблицу учетных движений. 
    * Условие переноса позиций. Для переноса информации в таблицу учетных движений можно задать условие переноса позиций. Условие задается формулой в данном поле. Если условие будет выполнено, то позиция будет перенесена, иначе - нет. Как и условие переноса значений, условие переноса позиций так же задается формулой, которая должна возвращать значение логического типа. 
При добавлении позиций учетных движений в документ-приемник, тип движения создаваемых строк может быть определен условиями. Условия задаются в таблице, в которой указывается: 
        * Создать строчку с типом движения. В данной колонке задается тип движения, создаваемой строки в документе-приемнике. Выбрать необходимый тип движения можно из картотеки "Типов движений", нажатием на кнопку обзора в данном поле. 
        * Если строка исходного документа удовлетворяет условию. В зависимости от значения введенного условия будет создаваться строка с указанным типом движения. Условие задается в виде формулы, возвращающей логическое значение (Истина или Ложь) и вычисляемой в контексте исходной строки. 

Нужный тип движения определяется следующим образом: вычисляется формула первого условия, и если ее значение - "Истина", то для вновь создаваемой строки используется указанный для нее тип движения, иначе - проверяется следующее условие, пока не будет достигнут конец списка. Если тип движения таким образом не удалось определить, то в случае заполнения из документа - принимается равным типу движения из исходного документа. 


Если в поле "Разбивка на документы" был выбран вариант "По формуле разбиения", то при создании документов могут быть созданы сразу несколько документов, в зависимости от указанных значений в следующих настройках: 
* В поле "Формула разбиения" задается формула, значение которой будет являться параметром разбиения документа-основания. Указывая формулу разбиения, следует воспользоваться редактором формул, который открывается при помощи кнопки обзора. 
* Записать значение в реквизит. Значение формулы разбиения может быть записано в "шапочный" реквизит документа. Для этого реквизит следует указать в данном поле. 

Настройка табличной части выглядит в виде таблицы, где указывается Тип приемника, Приемник данных таблицы, При условии, Заполнять по формуле. Все перечисленные параметры заполняются аналогично настройкам переноса шапки. Формулы заполнения реквизитов табличной части аналогичны формулам, используемым при настройке пересчетов реквизитов в карточке типа объекта, а кнопка обзора в поле "Заполнять по формуле" открывает редактор формул. 

К тому же, если в поле "Разбивка на документы" был выбран вариант "По признакам разбиения в таблице", то в настройке табличного переноса добавляется колонка "Разбиение". Взведенные "флаги" в этой колонке показывают, какие значение реквизитов (полей, доп.полей) будут являться "формулами разбиения". В каждый, вновь созданный документ, попадут строки, вычисленные по формулам разбиения, с одинаковыми значениями. 

* Настройка прочих переносов

Перечень других таблиц документа, которые необходимо переносить. Настройка отображена в виде таблицы "Переносить подтаблицы", где можно указать, какие именно подтаблицы также можно перенести в документ - приемник. Данная настройка необходима, если в информационной базе был указан проект "Контроль". 

* Настройка заполнения после переноса.
На этом этапе производятся вычисления уже в самом документе-приемнике (в созданном). Настройка представлена в виде таблицы, где перечислены следующие параметры: 
    * Затем заполнить реквизит. В данной колонке указывается реквизит, значение которого зависит от данных шапки или таблицы учетных движений, и который нужно заполнить после того, как перенесены все остальные данные. 
    * При условии. Задавая формулу в данном поле, тем самым указывается условие, которое можно наложить на реквизит. Если условие выполняется, то реквизит можно будет заполнить, иначе - нет. 
    * По формуле. В данном поле указывается формула, по которой будет заполняться реквизит. 


* Настройка отображения результата.
После создания, документы могут быть открыты в карточке объекта на представлении. Такая возможность предоставляется опцией "Открывать созданные документы на экране на представлении": 
    * Опция отключена - документ создастся без отображения на экране. 
    * Опция включена. При этом становится доступным поле, в котором можно указать необходимое представление. Если оставить данное поле незаполненным, то документ после создания будет открыт на представлении используемом "по умолчанию" (первое представление, указанное в настройках внешнего вида типа объекта). 

Так же при установке опции "Открывать созданные документы на экране на представлении" доступен флаг "Открывать модально". Если флаг установлен, то карточка объекта будет открыта в модальном режиме. Однако следует заметить, если в поле "Созданный документ сохранять" выбран либо вариант "Вместе с основанием (до него)", либо "Вместе с основанием (после него)", тогда опция "Открывать модально" будет всегда включена. Так как невозможно сохранить документ-приемник отдельно от его основания. 

Везде, где могут быть указаны реквизиты, также могут быть введены сервисные процедуры. Особенно это может быть полезно в переносах шапки и дополнительных пересчетах, выполняемых после переноса. 
Например, если требуется перед началом переноса очистить все позиции заполняемого документа, то этого можно добиться, добавив в раздел "Настройка переноса шапки" реквизит - сервисную процедуру "Очистить позиции". Аналогично, если после заполнения документа требуется свернуть позиции, просуммировав учетные движения с одинаковыми атрибутами, можно добавить в раздел "Настройка заполнения после переноса" реквизит - сервисную процедуру с классом реализации "Сервис сворачивания позиций". Формулы для заполнения этих реквизитов в обоих приведенных примерах заполнять не нужно. 

 


#### Вариант переноса "Заполнить данный документ на основании существующего" 

Данный вариант заполнения является обратным варианту заполнения "Создать новый документ на основании данного": пользователю предлагается выбрать в картотеке процессов/документов один из имеющихся в системе документов, после чего информация из него переносится в документ, из которого вызван данный сервис. 

* Настройка варианта заполнения
    * Вид связи между документами. По умолчанию, после заполнения документа на основании другого, сохраняется ссылка на документ-основание. Однако можно настроить связь между документом-основанием и заполняемым документом с помощью данной опцией. Возможные значения: 
         * Не сохранять ссылку на документ-основание - ссылка на документ-основание не будет сохранена.
         * Сохранять в новом документе ссылку на документ-основание - ссылка будет сохранена. В этом случае доступна опция "При удалении документа-основания", где можно указать: 
              * Требовать очистки ссылки из созданного документа. При выбранном варианте, если документ-основание удаляется, пользователю будет задан вопрос об очистке ссылок из документов-приемников. Если пользователь подтвердит очистку ссылок, то удаление пройдет успешно, иначе документ-основание не удалится. 
              * Удалять ссылку автоматически - ссылка будет удалена, не сообщив пользователю об удалении. Документ-основание удалится в любом случае. 
    * Добавлять новый документ в список зависимостей исходного - эта опция доступна только в том случае, если в настройках информационной базы указано использование проекта "Контроль". Если выбран этот вариант связи, то созданный/заполняемый документ будет добавлен в список зависимостей документа-основания. 
    * Реквизит "Документ-основание". Устанавливается реквизит - документ, на основании которого будет перенесена информация в текущий документ. Если данное полене заполнено, тогда будет открываться картотека, из которой можно будет выбрать необходимый документ-основание. 
    * Фильтр на картотеку. Если поле Реквизит "Документ-основание" не заполнено, тогда предоставляется возможность установить фильтр на картотеку, из которой можно выбрать необходимый документ-основание. Настройка фильтра на картотеку описана в разделе "Фильтр на картотеку / Условие отбора для отчета" 
    * В поле "Произвольный фильтр на картотеку" задается произвольный фильтр в контексте того типа документа, в котором был вызван сервис. Кнопка обзора в данном поле открывает диалог "Редактор формул реквизита", где задается формула. Формула должна возвращать значение типа строка. 
* Остальные Настройки переноса при данном варианте заполнения производится аналогично настройкам в варианте переноса "Создать новый документ на основании данного". 

#### Вариант переноса "Заполнить документ из встроенного в него отчета" 

Данный вариант заполнения предполагает наличие в карточке объекта представления типа "Отчет". При варианте заполнения документа из встроенного отчета информация переноситься из отчета в документ, в котором находится представление типа "Отчет". 

* Настройка переноса шапки  предоставляется возможность настроить параметры переноса шапки из документа. Данная настройка аналогична настройке переноса шапки в варианте переноса "Создать новый документ на основании данного". Настройка переноса шапки из документа в данном варианте необходима, для каких либо предварительных действий.
Например, если требуется перед началом переноса очистить все позиции заполняемого документа, то этого можно добиться, добавив в настройку переноса шапки из документа реквизит - сервисную процедуру "Очистить позиции". 
Настроить перенос шапки из отчета: 
    * Тип приемника. Аналогично переносу шапки из документа, можно настроить в каком виде будет приниматься информация из отчета в заполняемый документ. Это может быть либо реквизит, либо дополнительное поле, либо поле записи типа "объект". 
    * Приемник данных шапки. В данном поле указывается сам приемник. В зависимости от того, что было выбрано типом приемника, можно выбрать либо реквизит, либо поле типа "объект", либо указать дополнительное поле, вписав его вручную. 
    * При условии. Накладываемое условие, должно возвращать логическое значение (Истина/Ложь). При выполнении условия, значение будет записываться либо в реквизит, либо в дополнительное поле, либо в поле типа "объект". 
    * Заполнять по формуле из отчета. Формула заполнения пишется по тем же правилам, что и формулы в параметрическом отчете, для чего можно использовать редактор формул, открывающийся по кнопке обзора в поле формулы. Следует обратить внимание, что в данном случае указывается реквизит, поле или дополнительное поле заполняемого документа, а формула вычисляется в контексте отчета. 
* Настройки табличного переноса
    * Флаг "При заполнении создавать новые учетные движения" позволяет создавать в документе учетные движения. 
Если флаг не установлен, тогда предоставляется возможность разбить отчет по строкам и записать в соответствующий реквизит, который в последствии установить на заполняемом документе. 
    Если флаг установлен, тогда предоставляется возможность указать: 
        * Создать строчку с типом движения. В данной колонке задается нужный тип движения в документе-приемнике. Выбрать необходимый тип движения можно из картотеки "Типов движений", нажатием на кнопку обзора в данном поле. 
        * Если строка исходного документа удовлетворяет условию. В зависимости от значения введенного условия будет создаваться строка с указанным типом движения. Условие задается в виде формулы, возвращающей логическое значение (Истина или Ложь) и вычисляемой в контексте исходной строки. 

Нужный тип движения определяется следующим образом: вычисляется формула первого условия, и если ее значение - "Истина", то для вновь создаваемой строки используется указанный для нее тип движения, иначе - проверяется следующее условие, пока не будет достигнут конец списка. 

Настройка переноса табличной части в данном варианте переноса аналогична настройкам в варианте переноса "Создать новый документ на основании данного". В данном режиме формулы для заполнения табличных реквизитов задаются по тем же правилам, что и формулы в параметрическом отчете. Для формулы может быть указан признак "Ключ", объявляющий данную формулу ключевой. Строка из отчета будет перенесена в документ, если, по крайней мере, одна ключевая формула дает ненулевой (непустой) результат. 
* Настройка заполнения после переноса
На данном этапе заполнения, указываются реквизиты, которые должны быть заполнены после переноса информации из отчета в текущий документ. Например, если после заполнения документа требуется свернуть позиции, просуммировав учетные движения с одинаковыми атрибутами, можно добавить в данный раздел реквизит - сервисную процедуру с классом реализации "Сервис сворачивания позиций" . Данная настройка аналогична настройкам в варианте переноса "Создать новый документ на основании данного". 


#### Вариант переноса "Заполнить документ из отчета" 

Данный вариант заполнения аналогичен варианту переноса "Заполнить документ из встроенного в него отчета" за тем исключением, что отчет, из которого берется информация для заполнения таблицы учетных движений, не является встроенным в карточку объекта, а открывается модально по нажатию на кнопку реквизита-сервиса. Другими словами, данный вариант заполнения предполагает, что на заполняемом документе установлен реквизит-сервис, нажав на который открывается отчет в модальном окне, откуда переносится информация в заполняемый документ. 


* Настройка варианта заполнения
    * Отчет-источник. В данное поле предоставляется возможность ввести отчет, который будет открываться при нажатии на кнопку реквизита-сервиса. Необходимый отчет следует выбрать из картотеки "Общих отчетов" нажатием на кнопку обзора, либо ввести его вручную. 
    * Режим построения отчета. Можно выбрать один из вариантов построения отчета, либо в фоновом режиме, либо в модальном окне. 
    * Флаг "Не строить отчет при открытии" предназначен, чтобы при открытии отчет строился не сразу, а только после нажатия на кнопку "Построить" на отчете. 
    * В полях Период можно задать формулу, которая будет вычислять начальную и конечную даты, по которым будет строиться отчет. Если же в данных полях ничего не было указано, тогда за начальную дату принимается минимальная дата проводки, а за конечную дату - дата документа. 
    * В таблице "Условия отбора для отчета" можно наложить условия на параметры для открывающегося отчета. Параметры накладываемого отчета описаны в разделе Фильтр на картотеку / Условие отбора для отчета 
    * Таблица "Связь реквизитов с параметрами отчетов" предназначена для указания реквизитов, в которые будут записаны параметры отчета. При выполнении отчета указываются условие отбора проводок по параметрам входящих в них счетов. Это условие отображено после выполнения отчета, как параметры. 
        * Реквизит. В данном поле выбирается реквизит, в который будет перенесена информация из параметров отчета в заполняемый документ. 
        * В поле "Параметр отчета" указываются параметры, которые будут записаны в реквизиты заполняемого документа. В выпадающем списке предоставляется выбрать параметр отчета. Данный список будет доступен, если в поле "Отчет-источник"  был указан отчет с параметрами. 

* Настройка переноса шапки

На данном этапе настройки настраивается перенос информации из отчета в шапку заполняемого документа. Настройка переноса шапки в данном варианте заполнения разделяется на две настройки: Настройка переноса шапки из документа и Настройка переноса шапки из отчета, которые аналогичны настройкам варианта переноса "Заполнить документ из встроенного в него отчета". Настройка переноса шапки из документа в данном варианте необходима для каких либо предварительных действий. Например, если требуется перед началом переноса очистить все позиции заполняемого документа, то этого можно добиться, добавив в настройку переноса шапки из документа реквизит-сервисную процедуру "Очистить позиции". 

* Настройки табличного переноса

Настройка табличного переноса в данном варианте заполнения схожа с настройками табличного переноса в варианте переноса "Создать новый документ на основании данного" 

Кроме того, добавляется настройка, которая позволяет разбить отчет по строкам и записать в соответствующий реквизит, который впоследствии установить на заполняемом документе. 

* Настройки заполнения после переноса

Настройки заполнения после переноса точно такие же, как и в варианте переноса "Создать новый документ на основании данного". 


#### Вариант переноса "Создать новый документ на основании данного документа и отчета" 

Данный вариант переноса создает один или более документов. Шапка создаваемых документов заполняется информацией из документа, в котором вызван данный сервис, а в таблицу учетных движений созданного документа переноситься информация из отчета, встроенного в карточку исходного документа. 

* Настройка варианта заполнения - настраиваются такие поля, как Тип нового документа, Разбивка на документы, Вид связи между документами, Созданный документ сохранять. Настройка данного этапа практически идентична настройке в варианте переноса "Создать новый документ на основании данного", за тем исключением, что в данном варианте отсутствует поле "Поместить в реквизит". 
    * флаг "Всегда создавать документы при переносе из отчета". Установка данного флага позволяет создавать документы из отчета, если даже отчет не передает никаких данных. 

* Настройка переноса шапки

Настраивается перенос информации в шапку создаваемого документа из отчета и документа - основания, в котором вызван сервис. Данная настройка аналогична настройкам в варианте "Заполнить документ из встроенного в него отчета", где можно по отдельности настроить переноса шапки из документа и переноса шапки из отчета. 

* Настройка табличного переноса

Настройка табличного переноса подобна настройкам варианта "Создать новый документ на основании данного" за тем исключением, что в настройке данного варианта нет поля "Условия переноса позиции" и в таблице заполнения приемника данных, формула вычисляется в контексте отчета. Как и в варианте "Заполнить документ из встроенного в него отчета", можно указывать ключевые формулы. Строка из отчета переносится в документ, если, по крайней мере, одна ключевая формула дает ненулевой (непустой) результат. 

* Настройка заполнения после переноса

Производятся необходимые вычисления после переноса в созданный документ. Настройка аналогична настройке в варианте переноса "Создать новый документ на основании данного".

* Настройка отображения результата

Настраивают отображение результата переноса. Настройка аналогична настройке в варианте "Создать новый документ на основании данного". 


#### Вариант переноса "Заполнить существующий документ на основании его самого" 

Этот вариант заполнения аналогичен варианту "Заполнить данный документ на основании существующего" за тем исключением, что в качестве документа-основания выступает этот же документ. Другими словами, при данном варианте переноса, информация переноситься из документа, который и необходимо заполнить, т.е. из самого себя. 

* Настройка переноса шапки представлена в виде таблице, которая подобна настройкам переноса шапки в варианте переноса "Создать новый документ на основании данного". 

* Настройка табличного переноса
    * Флаг "При заполнении создавать новые учетные движения". Если эта опция включена (флаг установлен), то в документ будут продублированы учетные движения со значениями реквизитов, полей или дополнительных полей, рассчитанных по формулам переноса. Если же флаг не установлен, то сервис откорректирует реквизиты, поля или дополнительные поля в существующих учетных движениях и не станет создавать новые. 

Все остальные настройки аналогичны настройке табличного переноса в варианте "Создать новый документ на основании данного" 

* Настройка заполнения после переноса

Настройка заполнения после переноса схожа с настройками в варианте "Создать новый документ на основании данного". Заполнение табличных реквизитов после переноса будет проходить только для добавленных сервисом позиций. 


#### Вариант переноса "Заполнить существующий документ на основании данного" 

Данный вариант переносит информацию из документа, в котором был вызван сервис в существующий документ. Другими словами, этот вариант переноса информации модифицирует существующий документ на основании данного.

* Настройка варианта заполнения
    * В поле "Модифицировать документ" указывается реквизит - документ, в который будет перенесена информация. Следует обратить внимание, что реквизит должен иметь тип "Процесс" 
    * Поле "Модифицированный документ сохранять". Предоставляется возможность сохранить модифицированный документ: 
        * Сразу. Модифицированный документ будет сохранен сразу, независимо от того, был ли сохранен документ - основание. 
        * Вместе с основанием (до него) - сначала будет сохранен модифицированный документ, затем документ - основание. Такой вариант сохранения необходим, чтобы не нарушить порядок записи элементов и групп. В данном случае, будет создан сначала элемент, а затем группа, в котором будет находиться созданный элемент. Однако если документ-основание не был сохранен, то и созданный на его основании документ тоже не будет сохранен. 
        * Вместе с основанием (после него) - при сохранении, сначала будет сохранен документ-основание, затем модифицированный документ. Другими словами, модифицированный документ будет сохранен в том случае, если документ-основание сохранили. Иначе - ни один из документов, как документ-основание, так и модифицированный, не будут сохранены. В этом случае, сначала будет создана группа, а затем уже и сам элемент этой группы. Порядок записи групп и элементов не будет нарушен. 
* Остальные Настройки переноса при данном варианте заполнения производится аналогично настройкам в варианте переноса "Создать новый документ на основании данного". 
